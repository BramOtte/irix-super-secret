var ae=(o=>(o[o.ADD=0]="ADD",o[o.RSH=1]="RSH",o[o.LOD=2]="LOD",o[o.STR=3]="STR",o[o.BGE=4]="BGE",o[o.NOR=5]="NOR",o[o.IMM=6]="IMM",o[o.SUB=7]="SUB",o[o.JMP=8]="JMP",o[o.MOV=9]="MOV",o[o.NOP=10]="NOP",o[o.LSH=11]="LSH",o[o.INC=12]="INC",o[o.DEC=13]="DEC",o[o.NEG=14]="NEG",o[o.AND=15]="AND",o[o.OR=16]="OR",o[o.NOT=17]="NOT",o[o.XNOR=18]="XNOR",o[o.XOR=19]="XOR",o[o.NAND=20]="NAND",o[o.BRL=21]="BRL",o[o.BRG=22]="BRG",o[o.BRE=23]="BRE",o[o.BNE=24]="BNE",o[o.BOD=25]="BOD",o[o.BEV=26]="BEV",o[o.BLE=27]="BLE",o[o.BRZ=28]="BRZ",o[o.BNZ=29]="BNZ",o[o.BRN=30]="BRN",o[o.BRP=31]="BRP",o[o.PSH=32]="PSH",o[o.POP=33]="POP",o[o.CAL=34]="CAL",o[o.RET=35]="RET",o[o.HLT=36]="HLT",o[o.CPY=37]="CPY",o[o.BRC=38]="BRC",o[o.BNC=39]="BNC",o[o.MLT=40]="MLT",o[o.DIV=41]="DIV",o[o.MOD=42]="MOD",o[o.BSR=43]="BSR",o[o.BSL=44]="BSL",o[o.SRS=45]="SRS",o[o.BSS=46]="BSS",o[o.SETE=47]="SETE",o[o.SETNE=48]="SETNE",o[o.SETG=49]="SETG",o[o.SETL=50]="SETL",o[o.SETGE=51]="SETGE",o[o.SETLE=52]="SETLE",o[o.SETC=53]="SETC",o[o.SETNC=54]="SETNC",o[o.LLOD=55]="LLOD",o[o.LSTR=56]="LSTR",o[o.IN=57]="IN",o[o.OUT=58]="OUT",o[o.SDIV=59]="SDIV",o[o.SBRL=60]="SBRL",o[o.SBRG=61]="SBRG",o[o.SBLE=62]="SBLE",o[o.SBGE=63]="SBGE",o[o.SSETL=64]="SSETL",o[o.SSETG=65]="SSETG",o[o.SSETLE=66]="SSETLE",o[o.SSETGE=67]="SSETGE",o[o.__ASSERT=68]="__ASSERT",o[o.__ASSERT0=69]="__ASSERT0",o[o.__ASSERT_EQ=70]="__ASSERT_EQ",o[o.__ASSERT_NEQ=71]="__ASSERT_NEQ",o))(ae||{}),ee=(n=>(n[n.PC=0]="PC",n[n.SP=1]="SP",n))(ee||{}),D=ke(ee);var ve=(a=>(a[a.Reg=0]="Reg",a[a.Imm=1]="Imm",a[a.Memory=2]="Memory",a[a.Label=3]="Label",a[a.Data_Label=4]="Data_Label",a[a.Constant=5]="Constant",a[a.String=6]="String",a))(ve||{}),Oe=(s=>(s[s.SET=0]="SET",s[s.GET=1]="GET",s[s.GET_RAM=2]="GET_RAM",s[s.SET_RAM=3]="SET_RAM",s[s.RAM_OFFSET=4]="RAM_OFFSET",s))(Oe||{}),te=(s=>(s[s.BITS=0]="BITS",s[s.MINREG=1]="MINREG",s[s.MINHEAP=2]="MINHEAP",s[s.RUN=3]="RUN",s[s.MINSTACK=4]="MINSTACK",s))(te||{}),ue=(d=>(d[d.BITS=0]="BITS",d[d.MSB=1]="MSB",d[d.SMSB=2]="SMSB",d[d.MAX=3]="MAX",d[d.SMAX=4]="SMAX",d[d.UHALF=5]="UHALF",d[d.LHALF=6]="LHALF",d[d.MINREG=7]="MINREG",d[d.MINHEAP=8]="MINHEAP",d[d.HEAP=9]="HEAP",d[d.MINSTACK=10]="MINSTACK",d))(ue||{}),ce=(e=>(e[e["=="]=0]="==",e[e["<="]=1]="<=",e[e[">="]=2]=">=",e))(ce||{}),ye=(n=>(n[n.ROM=0]="ROM",n[n.RAM=1]="RAM",n))(ye||{}),Ee={[0]:{def:8,def_operant:0},[1]:{def:8},[2]:{def:16},[3]:{def:0,in:ye},[4]:{def:8}},T=(u=>(u[u.CPUBUS=0]="CPUBUS",u[u.TEXT=1]="TEXT",u[u.NUMB=2]="NUMB",u[u.SUPPORTED=5]="SUPPORTED",u[u.SPECIAL=6]="SPECIAL",u[u.PROFILE=7]="PROFILE",u[u.X=8]="X",u[u.Y=9]="Y",u[u.COLOR=10]="COLOR",u[u.BUFFER=11]="BUFFER",u[u.G_SPECIAL=15]="G_SPECIAL",u[u.ASCII=16]="ASCII",u[u.CHAR5=17]="CHAR5",u[u.CHAR6=18]="CHAR6",u[u.ASCII7=19]="ASCII7",u[u.UTF8=20]="UTF8",u[u.UTF16=21]="UTF16",u[u.UTF32=22]="UTF32",u[u.T_SPECIAL=23]="T_SPECIAL",u[u.INT=24]="INT",u[u.UINT=25]="UINT",u[u.BIN=26]="BIN",u[u.HEX=27]="HEX",u[u.FLOAT=28]="FLOAT",u[u.FIXED=29]="FIXED",u[u.N_SPECIAL=31]="N_SPECIAL",u[u.ADDR=32]="ADDR",u[u.BUS=33]="BUS",u[u.PAGE=34]="PAGE",u[u.S_SPECIAL=39]="S_SPECIAL",u[u.RNG=40]="RNG",u[u.NOTE=41]="NOTE",u[u.INSTR=42]="INSTR",u[u.NLEG=43]="NLEG",u[u.WAIT=44]="WAIT",u[u.NADDR=45]="NADDR",u[u.DATA=46]="DATA",u[u.M_SPECIAL=47]="M_SPECIAL",u[u.UD1=48]="UD1",u[u.UD2=49]="UD2",u[u.UD3=50]="UD3",u[u.UD4=51]="UD4",u[u.UD5=52]="UD5",u[u.UD6=53]="UD6",u[u.UD7=54]="UD7",u[u.UD8=55]="UD8",u[u.UD9=56]="UD9",u[u.UD10=57]="UD10",u[u.UD11=58]="UD11",u[u.UD12=59]="UD12",u[u.UD13=60]="UD13",u[u.UD14=61]="UD14",u[u.UD15=62]="UD15",u[u.UD16=63]="UD16",u[u.GAMEPAD=64]="GAMEPAD",u[u.AXIS=65]="AXIS",u[u.GAMEPAD_INFO=66]="GAMEPAD_INFO",u[u.KEY=67]="KEY",u[u.MOUSE_X=68]="MOUSE_X",u[u.MOUSE_Y=69]="MOUSE_Y",u[u.MOUSE_DX=70]="MOUSE_DX",u[u.MOUSE_DY=71]="MOUSE_DY",u[u.MOUSE_DWHEEL=72]="MOUSE_DWHEEL",u[u.MOUSE_BUTTONS=73]="MOUSE_BUTTONS",u[u.FILE=74]="FILE",u))(T||{}),{SET:b,GET:c,GET_RAM:Ze,SET_RAM:Je,RAM_OFFSET:Tt}=Oe,we={[0]:[[b,c,c],e=>{e.a=e.b+e.c}],[1]:[[b,c],e=>{e.a=e.b>>>1}],[2]:[[b,Ze],e=>{e.a=e.m_get(e.b)}],[3]:[[Je,c],e=>e.m_set(e.a,e.b)],[4]:[[c,c,c],e=>{e.b>=e.c&&(e.pc=e.a)}],[63]:[[c,c,c],e=>{e.sb>=e.sc&&(e.pc=e.a)}],[5]:[[b,c,c],e=>{e.a=~(e.b|e.c)}],[6]:[[b,c],e=>{e.a=e.b}],[7]:[[b,c,c],e=>{e.a=e.b-e.c}],[8]:[[c],e=>{e.pc=e.a}],[9]:[[b,c],e=>{e.a=e.b}],[10]:[[],()=>!1],[11]:[[b,c],e=>{e.a=e.b<<1}],[12]:[[b,c],e=>{e.a=e.b+1}],[13]:[[b,c],e=>{e.a=e.b-1}],[14]:[[b,c],e=>{e.a=-e.b}],[15]:[[b,c,c],e=>{e.a=e.b&e.c}],[16]:[[b,c,c],e=>{e.a=e.b|e.c}],[17]:[[b,c],e=>{e.a=~e.b}],[18]:[[b,c,c],e=>{e.a=~(e.b^e.c)}],[19]:[[b,c,c],e=>{e.a=e.b^e.c}],[20]:[[b,c,c],e=>{e.a=~(e.b&e.c)}],[21]:[[c,c,c],e=>{e.b<e.c&&(e.pc=e.a)}],[60]:[[c,c,c],e=>{e.sb<e.sc&&(e.pc=e.a)}],[22]:[[c,c,c],e=>{e.b>e.c&&(e.pc=e.a)}],[61]:[[c,c,c],e=>{e.sb>e.sc&&(e.pc=e.sa)}],[23]:[[c,c,c],e=>{e.b===e.c&&(e.pc=e.a)}],[24]:[[c,c,c],e=>{e.b!==e.c&&(e.pc=e.a)}],[25]:[[c,c],e=>{e.b&1&&(e.pc=e.a)}],[26]:[[c,c],e=>{e.b&1||(e.pc=e.a)}],[27]:[[c,c,c],e=>{e.b<=e.c&&(e.pc=e.a)}],[62]:[[c,c,c],e=>{e.sb<=e.sc&&(e.pc=e.a)}],[28]:[[c,c],e=>{e.b===0&&(e.pc=e.a)}],[29]:[[c,c],e=>{e.b!==0&&(e.pc=e.a)}],[30]:[[c,c],e=>{e.b&e.sign_bit&&(e.pc=e.a)}],[31]:[[c,c],e=>{e.b&e.sign_bit||(e.pc=e.a)}],[32]:[[c],e=>{e.push(e.a)}],[33]:[[b],e=>{e.a=e.pop()}],[34]:[[c],e=>{e.push(e.pc),e.pc=e.a}],[35]:[[],e=>{e.pc=e.pop()}],[36]:[[],()=>!0],[37]:[[Je,Ze],e=>e.m_set(e.a,e.m_get(e.b))],[38]:[[c,c,c],e=>{e.b+e.c>e.max_value&&(e.pc=e.a)}],[39]:[[c,c,c],e=>{e.b+e.c<=e.max_value&&(e.pc=e.a)}],[40]:[[b,c,c],e=>{e.a=e.b*e.c}],[41]:[[b,c,c],e=>{e.a=e.b/e.c}],[59]:[[b,c,c],e=>{e.a=e.sb/e.sc}],[42]:[[b,c,c],e=>{e.a=e.b%e.c}],[43]:[[b,c,c],e=>{e.a=e.b>>>e.c}],[44]:[[b,c,c],e=>{e.a=e.b<<e.c}],[45]:[[b,c],e=>{e.a=e.sb>>1}],[46]:[[b,c,c],e=>{e.a=e.sb>>e.c}],[47]:[[b,c,c],e=>{e.a=e.b===e.c?e.max_value:0}],[48]:[[b,c,c],e=>{e.a=e.b!==e.c?e.max_value:0}],[49]:[[b,c,c],e=>{e.a=e.b>e.c?e.max_value:0}],[65]:[[b,c,c],e=>{e.a=e.sb>e.sc?e.max_value:0}],[50]:[[b,c,c],e=>{e.a=e.b<e.c?e.max_value:0}],[64]:[[b,c,c],e=>{e.a=e.sb<e.sc?e.max_value:0}],[51]:[[b,c,c],e=>{e.a=e.b>=e.c?e.max_value:0}],[67]:[[b,c,c],e=>{e.a=e.sb>=e.sc?e.max_value:0}],[52]:[[b,c,c],e=>{e.a=e.b<=e.c?e.max_value:0}],[66]:[[b,c,c],e=>{e.a=e.sb<=e.sc?e.max_value:0}],[53]:[[b,c,c],e=>{e.a=e.b+e.c>e.max_value?e.max_value:0}],[54]:[[b,c,c],e=>{e.a=e.b+e.c<=e.max_value?e.max_value:0}],[55]:[[b,Tt,Ze],e=>{e.a=e.m_get(e.b+e.c)}],[56]:[[Tt,Je,c],e=>e.m_set(e.a+e.b,e.c)],[57]:[[b,c],e=>e.in(e.b)],[58]:[[c,c],e=>{e.out(e.a,e.b)}],[68]:[[c],e=>{e.a||xe(e,`value = ${e.a}`)}],[69]:[[c],e=>{e.a&&xe(e,`value = ${e.a}`)}],[70]:[[c,c],e=>{e.a!==e.b&&xe(e,`left = ${e.a}, right = ${e.b}`)}],[71]:[[c,c],e=>{e.a===e.b&&xe(e,`left = ${e.a}, right = ${e.b}`)}]},hi=et(we,(e,t)=>{if(t===void 0)throw new Error("instruction definition undefined");return[e,t?.[1]]},[]),Rt=et(we,(e,t)=>{if(t===void 0)throw new Error("instruction definition undefined");return[e,t[0].length]},[]);function xe(e,t){let n=`Assertion failed: ${t}`;e.warn(n)}function _(e,t){return{line_nr:e,message:t}}function Re(e,t,n){let{message:i,line_nr:r}=e;return`${n??"urcl"}:${r+1} - ${i}
   ${t[r]}`}function N(e,t,n=" "){let i=Math.max(0,t-e.length);return n.repeat(i)+e}function tt(e,t,n=" ",i=n){let r=Math.max(0,t-e.length),s=0|r/2,l=r-s;return n.repeat(s)+e+i.repeat(l)}function q(e,t,n=" "){return N(e.toString(16),t,n).toUpperCase()}function St(e){return Math.ceil(e/4)}function Se(e){let t=St(e.bits);return Array.from({length:D},(n,i)=>tt(ee[i],t)+" ").join("")+Array.from({length:e.registers.length-D},(n,i)=>N(`R${i+1}`,t)+" ").join("")+`
`+Array.from(e.registers,n=>q(n,t)+" ").join("")}function At(e,t=0,n=4096,i=8){let s=Math.min(t+n,e.length),l=St(i),a=[" ".repeat(l)+Array.from({length:16},(h,m)=>N(q(m,1),l)).join(" ")];for(let h=t;h<s;){let m=Math.min(h+16,s),f=[],d=q(0|h/16,l-1," ");for(;h<m;h++)f.push(q(e[h],l));let p=f.join(" ");a.push(d+" ".repeat(l-d.length)+p)}return a.join(`
`)}function Lt(e,t){let n=" ".repeat(t);return e.split(`
`).map(i=>n+i).join(`
`)}function et(e,t,n={}){let i=n;for(let r in e){let s=e[r],[l,a]=t(r,s);i[l]=a}return i}var Dt="0".charCodeAt(0),xn=Dt+9;function nt(e,t=0){let n=e.charCodeAt(t);return n>=Dt&&n<=xn}function vn(e){let t=-1;for(let n in e){let i=e[n];typeof i=="number"&&(t=Math.max(t,i))}return t}function ke(e){return vn(e)+1}function V(e){let t=[];for(let n in e){let i=e[n];typeof i=="string"&&t.push(i)}return t}function $(e,t){return nt(t)?void 0:e[t]}var Te=new DataView(new ArrayBuffer(8));function Bt(e){return Te.setInt32(0,e,!0),Te.getFloat32(0,!0)}function Ae(e){return Te.setFloat32(0,e,!0),Te.getInt32(0,!0)}function Ut(e){if(e===0)return 0;let t=e>>>15&1,n=e>>>10&31,r=((e&1023)/1024+1)*2**(n-15);return t?-r:r}function Le(e){let t=Math.sign(e);e*=t;let n=Math.floor(Math.log2(e)),i=e/2**n-1;return(t<0?1:0)<<15|(n+15&31)<<10|i*1024&1023}function $t(e,t,n){let i=new DataView(e.buffer,e.byteOffset,e.byteLength),r=new Uint16Array(Math.floor(Math.max(n,e.byteLength)/2));for(let s=0;s<Math.floor(e.byteLength/2);s++)r[s]=i.getUint16(s*2,t);return r}function Mt(e,t,n){let i=new DataView(e.buffer,e.byteOffset,e.byteLength),r=new Uint32Array(Math.floor(Math.max(n,e.byteLength)/4));for(let s=0;s<Math.floor(e.byteLength/4);s++)r[s]=i.getUint32(s*4,t);return r}function Nt(e,t){let n=new Uint8Array(e.length*2),i=new DataView(n.buffer,n.byteOffset,n.byteLength);for(let r=0;r<e.length;r++)i.setUint16(r*2,e[r],t);return n}function Ct(e,t){let n=new Uint8Array(e.length*4),i=new DataView(n.buffer,n.byteOffset,n.byteLength);for(let r=0;r<e.length;r++)i.setUint32(r*4,e[r],t);return n}function H(e){let t=Math.floor(e).toString(),n="",i=t.length;for(n=t.substring(i-3,i),i-=3;i>3;i-=3)n=t.substring(i-3,i)+"_"+n;return i>0&&(n=t.substring(0,i)+"_"+n),n}function le(e,t,n){return Math.max(t,Math.min(n,e))}function x(e,...t){return e.bind(null,...t)}function ne(e,t,n){let i=n.exec(e.substring(t));if(!(i===null||i.index!==0))return t+i[0].length}function De(e,t,n,i){for(let r of e){let s=r(t,n,i);if(s!==n)return s}return n}function it(e,t,n,i){for(let r=0;r<e.length;r++){let s=e[r],l=s(t,n,i);if(l===n)return n;l!=="skip"&&(n=l)}return n}function yn(e,t,n,i){let r=e(t,n,i);return r===n?"skip":r}function rt(e,t,n,i){for(;n<t.length;){let r=e(t,n,i);if(r===n)return n;r!=="skip"&&(n=r)}return n}function w(e,t,n,i,r){let s=ne(n,i,t);return s===void 0?i:(r.push({type:e,start:i,end:s}),s)}var Ht=x(w,"comment",/^\/\/[^\n]*/),En=x(w,"white",/^\s+/),Wt=x(w,"white-inline",/^(,|[^\S\n])+/),wn=x(w,"number",/^-?(0x[0-9a-fA-F_]+|0b[01_]+|[0-9_]+)/),kn=x(w,"register",/^[Rr$]([0-9_]+|0x[0-9a-fA-F_]+|0b[01_]+)/),Tn=x(w,"port",/^%\w+/),Rn=x(w,"port",/^[#mM]([0-9_]+|0x[0-9a-fA-F_]+|0b[01_]+)/),Gt=x(w,"escape",/^\\(x[0-9a-fA-F_]+|.)/),Ft=x(w,"quote-char",/^'/),It=x(w,"quote-string",/^"/),Sn=x(w,"relative",/^~-?(0x[0-9a-fA-F_]+|0b[01_]+|[0-9_]+)/),An=x(it,[x(w,"label",/^\.\w+/),x(yn,x(w,"number",/\+\d+/)),x(rt,x(De,[Ht,Wt]))]),Ln=x(it,[Ft,x(De,[Gt,x(w,"text",/^[^'\\]/)]),Ft]),Dn=x(it,[It,x(rt,x(De,[Gt,x(w,"text",/^[^"\\]+/)])),It]),zt=x(rt,x(De,[En,Wt,x(w,"comparator",/^<=|>=|==/),x(w,"macro",/^BITS|MINREG|MINHEAP|MINSTACK|RUN|HEAP/i),x(w,"text",/^RAM|ROM/i),wn,Ln,Dn,kn,Tn,Rn,An,Sn,Ht,x(w,"square-open",/\[/),x(w,"square-close",/\]/),x(w,"macro",/^@[a-zA-Z_][a-zA-Z_0-9]*/),x(w,"name",/^[a-zA-Z_][a-zA-Z_0-9]*/),x(w,"unknown",/^\S+/)]));var ot=class extends HTMLElement{line_nrs=document.createElement("div");code=document.createElement("div");input=document.createElement("textarea");colors=document.createElement("pre");profile_check=document.createElement("input");profiled=[];profile_present=!1;old_lines=[];tab_width=4;constructor(){super(),this.append(this.line_nrs,this.code),this.code.append(this.input,this.colors),this.code.style.position="relative",this.code.className="code",this.colors.className="colors",this.line_nrs.className="line-nrs",this.input.addEventListener("input",this.input_cb.bind(this)),this.input.spellcheck=!1,this.input.addEventListener("keydown",this.keydown_cb.bind(this)),this.profile_check.type="checkbox";let t=document.createElement("span");this.parentElement?.insertBefore(this.profile_check,this),t.textContent="Show line-profile",this.parentElement?.insertBefore(t,this)}get value(){return this.input.value}set value(t){this.input.value=t,this.input_cb()}pc_line=0;set_pc_line(t){let n=this.line_nrs.children[this.pc_line];n&&n.classList.remove("pc-line");let i=this.line_nrs.children[t];i&&i.classList.add("pc-line"),this.pc_line=t}set_line_profile(t){if(!this.profile_check.checked){if(!this.profile_present)return;this.profile_present=!1}let n=this.line_nrs.children,i=0;for(let[r,s]of t){for(;i<r;i++)if(this.profiled[i]){let l=n[r];l.textContent=`${i+1}`}if(this.profile_check.checked){let l=n[r];l.textContent=`${s} ${r+1}`}}}keydown_cb(t){if(t.key==="Tab"){t.preventDefault();let n=this.input.selectionStart,i=this.input.selectionEnd;if(!t.shiftKey&&n===i){let r=this.input.value,s=n-Kt(r,n),l=this.tab_width-s%this.tab_width||this.tab_width;this.input.value=he(r,n,0," ".repeat(l)),this.input.selectionStart=this.input.selectionEnd=n+l}else{let r=this.input.value;t.shiftKey?(st(r,n,i,s=>{let l=(ne(r,s,/^\s*/)??s)-s,a=l===0?0:l%this.tab_width||this.tab_width;return s<n&&(n-=a),i-=a,r=he(r,s,a,""),r}),this.input.value=r,this.input.selectionStart=n,this.input.selectionEnd=i):(st(r,n,i,s=>{let l=(ne(r,s,/^\s*/)??s)-s,a=this.tab_width-l%this.tab_width||this.tab_width;return s<n&&(n+=a),i+=a,r=he(r,s,0," ".repeat(a)),r}),this.input.value=r,this.input.selectionStart=n,this.input.selectionEnd=i)}this.input_cb()}else if(t.key==="/"&&t.ctrlKey){let n=this.input.selectionStart,i=this.input.selectionEnd,r=this.input.value;st(r,n,i,s=>{let l=ne(r,s,/^\s*/)??s;if(ne(r,l,/^\/\//)===void 0)r=he(r,l,0,"// "),s<n&&(n+=3),i+=3;else{let a=r[l+2]===" "?3:2;r=he(r,l,a,""),s<n&&(n-=a),i-=a}return r}),this.input.value=r,this.input.selectionStart=n,this.input.selectionEnd=i,this.input_cb()}}input_cb(){this.input.style.height="1px";let t=this.input.scrollHeight;this.input.style.width=`${this.input.scrollWidth}px`,this.input.style.height=`${t}px`;let n=this.input.value,i=this.old_lines,r=n.split(`
`);this.old_lines=r;{let d=(r.length+"").length,p=this.line_nrs.children.length,g=r.length-p;if(g>0)for(let y=0;y<g;y++){let E=this.line_nrs.appendChild(document.createElement("div"));E.textContent=N(""+(p+y+1),d)}else for(let y=0;y<-g;y++)this.line_nrs.lastChild?.remove()}let s=1e5;if(n.length>s){this.input.style.color="white",this.colors.style.color="transparent",this.call_input_listeners();return}this.input.style.color="transparent",this.colors.style.display="white";let l=Math.min(r.length,i.length),a=0;for(;a<l&&r[a]===i[a];a++);let h=0;for(;h<l-a&&r.at(-h-1)===i.at(-h-1);h++);let m=r.length-h,f=this.colors.children.item(i.length-h);for(;this.colors.children.length<r.length;){let d=document.createElement("div");f?this.colors.insertBefore(d,f):this.colors.appendChild(d)}for(;this.colors.children.length>r.length;){let d=this.colors.children[Math.min(this.colors.children.length,i.length)-h-1];if(!d){console.error("This should never happen"),this.input.style.color="white",this.colors.style.color="transparent";break}this.colors.removeChild(d)}for(let d=a;d<m;d++){let p=r[d],g=this.colors.children[d],y=[];if(zt(p,0,y),y.length===0){g.innerHTML=`<span>
</span>`;continue}let E=g.firstElementChild;for(let{type:k,start:R,end:U}of y)E||(E=document.createElement("span"),g.appendChild(E)),E.textContent=p.substring(R,U),E.className=k,E=E.nextElementSibling;for(;E;){let k=E.nextElementSibling;g.removeChild(E),E=k}}this.input.style.width=`${this.colors.scrollWidth}px`,this.colors.style.height=`${t}px`,this.call_input_listeners()}call_input_listeners(){for(let t of this.input_listeners)t.call(this,new Event("input"))}input_listeners=[];set oninput(t){this.input_listeners.push(t)}};customElements.define("editor-window",ot);function he(e,t,n,i){return e.slice(0,t)+i+e.slice(t+n)}function st(e,t,n,i){let r=Kt(e,t),s=e.indexOf(`
`,r)+1||e.length,l=1;for(;s<n;s=e.indexOf(`
`,s)+1||e.length)l++;for(let a=0,h=r;a<l;a++)e=i(h),h=e.indexOf(`
`,h)+1||e.length;return e}function Kt(e,t){let n=0,i=0;for(;n<=t;n=e.indexOf(`
`,n)+1||e.length)if(i=n,n>=e.length){i+1;break}return i}var Be=1e9,at=class extends HTMLElement{scroll_div=document.createElement("div");content=document.createElement("div");char=document.createElement("div");cw=8;ch=8;lines=[""];size=0;constructor(){super(),this.appendChild(this.scroll_div),this.scroll_div.appendChild(this.content),this.onscroll=()=>this.update(),this.onresize=()=>this.resize(),this.char.textContent="a",this.char.style.position="absolute",this.char.style.visibility="hidden",this.appendChild(this.char)}update(){let{ceil:t,floor:n}=Math,{clientWidth:i,clientHeight:r}=this.char,s=this.scrollLeft,l=this.scrollTop,a=this.clientWidth,h=this.clientHeight;this.render(n(s/i),n(l/r),t(a+1+1/i),t((h+2)/r))}resize(){let{clientWidth:t,clientHeight:n}=this.char;this.cw=t,this.ch=n;let i=this.scrollTop===this.scrollHeight-this.clientHeight,r=this.text_width,s=this.lines.length;return this.scroll_div.style.height=`${s*n}px`,this.scroll_div.style.width=`${r*t}px`,this.update(),i&&(this.scrollTop=this.scrollHeight*2),i}buf="";text_width=0;clear(){this.buf="",this.text_width=0,this.lines=[""],this.size=0,this.resize()}write(t){this.buf+=t}flush(){if(this.buf.length===0)return;let t=0;for(let r=this.buf.indexOf(`
`)+1;r>0;t=r,r=this.buf.indexOf(`
`,r)+1){let s=this.buf.substring(t,r-1),l=this.lines[this.lines.length-1]+=s;this.text_width=Math.max(l.length,this.text_width),this.size+=s.length,this.lines.push("")}let n=this.lines[this.lines.length-1]+=this.buf.substring(t,this.buf.length);this.text_width=Math.max(n.length,this.text_width),this.size+=this.buf.length-t,this.buf="";let i=0;for(;this.size>Be&&i+1<this.lines.length;i++)this.size-=this.lines[i].length;this.lines.splice(0,i),this.lines.length===1&&this.lines[0].length>Be&&(this.lines[0]=this.lines[0].substring(this.lines[0].length-Be),this.size=Be),this.resize()||(this.scrollTop-=this.ch*i)}render(t,n,i,r){let s=this.text_width,l=this.lines.length,a=le(t,0,s),h=le(t+i,0,s),m=le(n,0,l),f=le(n+r,0,l);this.content.style.top=`${m*this.ch}px`,this.content.style.left=`${a*this.cw}px`;let d="";for(let p=m;p<f;p++)d+=this.lines[p].substring(a,h)+`
`;this.content.textContent=d}};customElements.define("scroll-out",at);function Pt(e){let{headers:t,opcodes:n,operant_types:i,operant_values:r,instr_line_nrs:s,lines:l,register_breaks:a,program_breaks:h,data_breaks:m,heap_breaks:f,port_breaks:d}=e,p=e.headers[3]?.value===1,g=e.headers[0].value,y=g<=8?8:g<=16?16:g<=32?32:void 0;if(y===void 0)throw new Error("bits can not exceed 32");let E=1<<y-1,k=1<<y-2,R=4294967295>>>32-y,U=R>>>1,M=R&R<<y/2,X=R-M,O=t[1].value,Et=t[2].value,_n=t[4].value,wt=e.data.length,ge=r.map(se=>se.slice()),gn=i.map((se,oe)=>se.map((je,L)=>{switch(je){case 0:{let S=ge[oe][L]+1-D;if(S>O)throw new Error(`register ${S} does not exist, ${S} > minreg:${O}`);return 0}case 1:return 1;case 3:return 1;case 6:return 0;case 2:return ge[oe][L]+=wt,1;case 4:return 1;case 5:{let S=ge[oe],Qe=S[L];switch(Qe){case 0:S[L]=y;break;case 1:S[L]=E;break;case 2:S[L]=k;break;case 3:S[L]=R;break;case 4:S[L]=U;break;case 5:S[L]=M;break;case 6:S[L]=X;break;case 7:S[L]=O;break;case 8:S[L]=Et;break;case 9:S[L]=Et;break;case 10:S[L]=_n;break;default:throw new Error(`Unsupported constant ${Qe} ${ue[Qe]}`)}return 1}default:throw new Error(`Unkown opperant type ${je} ${ve[je]}`)}})),kt={...m};for(let[se,oe]of Object.entries(f))kt[Number(se)+wt]=oe;return[{headers:t,opcodes:n,operant_prims:gn,operant_values:ge,data:e.data},{pc_line_nrs:s,lines:l,program_breaks:h,memory_breaks:kt,register_breaks:a,port_breaks:d}]}var Ue=class{wait_end=0;time_out;inputs={[44]:this.wait_in};outputs={[44]:this.wait_out};wait_out(t){t===0?this.wait_end=-1:this.wait_end=Date.now()+t}wait_in(t){this.wait_end==-1?requestAnimationFrame(n=>t(n)):this.time_out=setTimeout(()=>t(1),this.wait_end-Date.now())}reset(){this.wait_end=0,this.time_out!==void 0&&clearTimeout(this.time_out)}};function Xt(e){let t="";for(let i=0;i<e.length;i+=4)t+="_"+e.substring(i,i+4);return t.startsWith("_")&&(t=t.substring(1)),t}var $e=class{constructor(t,n,i){this.input=t;this.write=n;this._reset=i}bits=32;inputs={[1]:this.text_in,[2]:this.numb_in,[28]:t=>{if(this.bits>=32)this.numb_in(t,n=>Ae(Number(n)));else if(this.bits>=16)this.numb_in(t,n=>Le(Number(n)));else throw new Error("8 bit floats are not supported")},[29]:t=>{this.numb_in(t,n=>Math.floor(Number(n)*2**(this.bits/2)))}};outputs={[1]:this.text_out,[2]:this.numb_out,[25]:this.numb_out,[27]:t=>this.write(Xt(t.toString(16).padStart(Math.ceil(this.bits/4),"0"))),[26]:t=>this.write(Xt(t.toString(2).padStart(this.bits,"0"))),[28]:t=>{if(this.bits>=32)this.write(Bt(t).toString());else if(this.bits>=16)this.write(Ut(t).toString());else throw new Error("8 bit floats are not supported")},[29]:t=>{this.write((t/2**(this.bits/2)).toString())},[24]:t=>{let n=2**(this.bits-1);t&n&&(t=(t&n-1)-n),this.write(t.toString())},[16]:this.text_out,[17]:this.text_out,[18]:this.text_out,[16]:this.text_out,[20]:this.text_out,[21]:this.text_out,[22]:this.text_out};set_text(t){this.input.text=t}reset(){this.input.text="",this._reset()}text_in(t){if(this.input.text.length===0){this.input.read(()=>{let i=this.input.text.codePointAt(0)??this.input.text.charCodeAt(0);this.input.text=this.input.text.slice(1),t(i)});return}let n=this.input.text.charCodeAt(0);return this.input.text=this.input.text.slice(1),n}text_out(t){this.write(String.fromCodePoint(t))}numb_in(t,n=parseInt){if(this.input.text.length!==0){let i=n(this.input.text);if(!Number.isNaN(i))return this.input.text=this.input.text.trimStart().slice(i.toString().length),i}this.input.read(()=>{let i=this.numb_in(t,n);i!==void 0&&t(i)})}numb_out(t){this.write(""+t)}};var j=(f=>(f[f.RGB=0]="RGB",f[f.Mono=1]="Mono",f[f.Bin=2]="Bin",f[f.RGB8=3]="RGB8",f[f.RGB16=4]="RGB16",f[f.RGB24=5]="RGB24",f[f.RGB6=6]="RGB6",f[f.RGB12=7]="RGB12",f[f.PICO8=8]="PICO8",f[f.RGBI=9]="RGBI",f))(j||{}),Vt=[0,1911635,8267091,34641,11227702,6248271,12764103,16773608,16711757,16753408,16772135,58422,2731519,8615580,16742312,16764074].map(e=>[e>>>16&255,e>>>8&255,e&255]);var Me=class{constructor(t){this.gamepad=t}xbox_mapping={0:1<<0,1:1<<1,8:1<<2,9:1<<3,12:1<<6,13:1<<7,14:1<<4,15:1<<5};info(t){return t==0?1:0}cleanup;chrome_fix(){let t=navigator.getGamepads()[this.gamepad.index];t!==null&&(this.gamepad=t)}get buttons(){this.chrome_fix();let t=0;return this.gamepad.buttons.forEach((n,i)=>{n.pressed&&(t+=this.xbox_mapping[i]??0)}),t}axis(t){return this.chrome_fix(),this.gamepad.axes[t]*127}};var Q=(h=>(h[h.A=0]="A",h[h.B=1]="B",h[h.SELECT=2]="SELECT",h[h.START=3]="START",h[h.LEFT=4]="LEFT",h[h.RIGHT=5]="RIGHT",h[h.UP=6]="UP",h[h.DOWN=7]="DOWN",h))(Q||{}),Ce=(r=>(r[r.LEFT_X=0]="LEFT_X",r[r.LEFT_Y=1]="LEFT_Y",r[r.RIGHT_X=2]="RIGHT_X",r[r.RIGHT_Y=3]="RIGHT_Y",r))(Ce||{}),Ne=class{pads=[];gamepads=new Map;selected=0;axis_index=0;info_index=0;constructor(){addEventListener("gamepadconnected",this.connect),addEventListener("gamepaddisconnected",this.disconnect)}cleanup(){for(let t of this.pads)t?.cleanup?.();removeEventListener("gamepadconnected",this.connect),removeEventListener("gamepaddisconnected",this.disconnect)}connect=t=>{let n=new Me(t.gamepad);console.log(n),this.gamepads.set(t.gamepad,n),this.add_pad(n)};disconnect=t=>{let n=this.gamepads.get(t.gamepad);n!==void 0&&(this.remove_pad(n),this.gamepads.delete(t.gamepad))};add_pad(t){this.pads.push(t)}remove_pad(t){let n=this.pads.indexOf(t);n<0||(this.pads[n]=void 0)}inputs={[64]:()=>this.pads[this.selected]?.buttons??0,[65]:()=>this.pads[this.selected]?.axis?.(this.axis_index)??0,[66]:()=>this.pads[this.selected]?.info(this.info_index)??0};outputs={[64]:t=>this.selected=t,[65]:t=>this.axis_index=t}};function qt(e,t,n){let i=Yt(e,e.VERTEX_SHADER,t),r=Yt(e,e.FRAGMENT_SHADER,n),s=e.createProgram();if(s==null)throw new Error("failed to create shader program");if(e.attachShader(s,i),e.attachShader(s,r),e.linkProgram(s),e.detachShader(s,i),e.detachShader(s,r),e.deleteShader(i),e.deleteShader(r),!e.getProgramParameter(s,e.LINK_STATUS)){e.deleteProgram(s);let l=e.getProgramInfoLog(s);throw new Error("Shader program did not link successfully. Error log: "+l)}return s}function Yt(e,t,n){let i=e.createShader(t);if(i==null)throw new Error("Failed to create shader");if(e.shaderSource(i,n),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){let r=e.getShaderInfoLog(i);throw e.deleteShader(i),new Error("Shader compile error: "+r)}return i}var Fe=class{constructor(t,n=8){this.color_mode=n;this.gl=t;let{drawingBufferWidth:i,drawingBufferHeight:r}=t;this.buffer=new Uint32Array(i*r),this.bytes=new Uint8Array(this.buffer.buffer,0,this.buffer.byteLength);let s=qt(t,this.vert_src,this.frag_src);t.useProgram(s);let l=t.getAttribLocation(s,"a_pos");if(l<0)throw new Error("program does not have attribute a_pos");let a=t.getAttribLocation(s,"a_uv");if(a<0)throw new Error("program does not have attribute a_uv");if(t.getUniformLocation(s,"u_image")===null)throw new Error("program does not have uniform u_image");let m=t.getUniformLocation(s,"u_color_mode");if(m===null)throw new Error("program does not have uniform u_color_mode");this.uni_mode=m,t.enableVertexAttribArray(l),t.enableVertexAttribArray(a);let f=t.createBuffer();if(f===null)throw new Error("unable to create webgl buffer");this.gl_vertices=f;let d=t.createBuffer();if(d===null)throw new Error("unable to create webgl buffer");this.gl_indices=d;let p=t.createTexture();if(p===null)throw new Error("unable to create webgl texture");this.gl_texture=p,t.bindTexture(t.TEXTURE_2D,p),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.bindBuffer(t.ARRAY_BUFFER,f),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d),t.vertexAttribPointer(l,2,t.FLOAT,!1,4*4,0),t.vertexAttribPointer(a,2,t.FLOAT,!1,4*4,4*2),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,2,1,0,2,3]),t.STATIC_DRAW),this.init_buffers(i,r)}gl;gl_vertices;gl_indices;gl_texture;uni_mode;buffer;bytes;buffer_enabled=0;x=0;y=0;pref_display=globalThis?.document?.getElementById?.("pref-display");bits=8;vert_src=`#version 300 es
    precision mediump float;
    in vec2 a_uv;
    in vec2 a_pos;

    out vec2 v_uv;

    void main(){
        gl_Position = vec4(a_pos, 0., 1.);
        v_uv = a_uv;
    }
    `;frag_src=`#version 300 es
    precision mediump float;
    in vec2 v_uv;
    out vec4 color;

    uniform sampler2D u_image;
    uniform uint u_color_mode;

    vec4 rgb(vec4 v, uint bits){
        uint color = uint(v.x * 255.) + (uint(v.y * 255.) << 8u) + (uint(v.z * 255.) << 16u);
        uint blue_bits = bits / 3u;
        uint blue_mask = (1u << blue_bits) - 1u;
        uint red_bits = (bits - blue_bits) / 2u;
        uint red_mask = (1u << red_bits) - 1u;
        uint green_bits = bits - blue_bits - red_bits;
        uint green_mask = (1u << green_bits) - 1u;
        
        uint green_offset = blue_bits;
        uint red_offset = green_offset + green_bits;
        return vec4(
            float((color >> red_offset   ) & red_mask) / float(red_mask),
            float((color >> green_offset ) & green_mask) / float(green_mask),
            float((color                  ) & blue_mask) / float(blue_mask),
            1
        );
    }
    vec4 rgbi(vec4 v){
        uint c = uint(v.x * 255.);
        uint r = (c >> 3u) & 1u;
        uint g = (c >> 2u) & 1u;
        uint b = (c >> 1u) & 1u;
        uint i = ((c >> 0u) & 1u) + 1u;
        if ((c & 15u) == 1u){
            return vec4(0.25, 0.25, 0.25, 1.);
        }
        return vec4(float(r*i)/2.1, float(g*i)/2.1, float(b*i)/2.1, 1.);
    }
    vec4 pallet_pico8[16] = vec4[16](
        ${Vt.map(t=>`vec4(${t.map(n=>n/255)},1.)`).join(",")}
    );

    vec4 pico8(vec4 v){
        return pallet_pico8[uint(v.x * 255.) & 15u];
    }

    vec4 mono(vec4 c){
        return vec4(c.x, c.x, c.x, 1);
    }

    vec4 bin(vec4 c){
        return c.x > 0. || c.y > 0. || c.z > 0. ? vec4(1,1,1,1) : vec4(0,0,0,1);
    }


    void main(){
        vec4 c = texture(u_image, v_uv);
        switch (u_color_mode){
            case ${2}u: color = bin(c); break;
            case ${1}u: color = mono(c); break;
            case ${8}u: color = pico8(c); break;
            case ${0}u: color = rgb(c, 8u); break;
            case ${6}u: color = rgb(c, 6u); break;
            case ${3}u: color = rgb(c, 8u); break;
            case ${7}u: color = rgb(c, 12u); break;
            case ${4}u: color = rgb(c, 16u); break;
            case ${5}u: color = rgb(c, 24u); break;
            case ${9}u: color = rgbi(c); break;
            default: color = pico8(c); break;
        }
    }
    
    `;inputs={[10]:this.color_in,[8]:this.x_in,[9]:this.y_in,[11]:this.buffer_in};outputs={[10]:this.color_out,[8]:this.x_out,[9]:this.y_out,[11]:this.buffer_out};reset(){this.x=0,this.y=0,this.clear(),this.buffer_enabled=0}resize(t,n){let i=new Uint32Array(t*n),r=Math.min(this.width,t),s=Math.min(this.height,n);for(let l=0;l<s;l++)for(let a=0;a<r;a++){let h=a+l*this.width,m=a+l*t;i[m]=this.buffer[h]}this.buffer=i,this.bytes=new Uint8Array(i.buffer,0,i.byteLength),this.width=t,this.height=n,this.init_buffers(t,n),this.update_display()}clear(){this.buffer.fill(0)}x_in(){return this.width}y_in(){return this.height}x_out(t){this.x=t}y_out(t){this.y=t}color_in(){return this.in_bounds(this.x,this.y)?this.buffer[this.x+this.y*this.width]:0}color_out(t){!this.in_bounds(this.x,this.y)||(this.buffer[this.x+this.y*this.width]=t,this.buffer_enabled||this.dirty_display())}buffer_in(){return this.buffer_enabled}start_t=0;buffer_out(t){switch(t){case 0:this.update_display(),this.clear(),this.buffer_enabled=0;break;case 1:this.start_t=performance.now(),this.buffer_enabled=1;break;case 2:{if(this.update_display(),this.pref_display){let i=performance.now()-this.start_t;this.pref_display.innerText=`frame time: ${i.toFixed(1)}ms`}this.start_t=performance.now()}break}}init_buffers(t,n){let{gl:i}=this;i.bufferData(i.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,1,-1,1,1,1,1,1,0,-1,1,0,0]),i.STATIC_DRAW),i.viewport(0,0,t,n)}dirty_display(){this.update_display()}update_display(){let{gl:t,width:n,height:i,bytes:r,uni_mode:s,color_mode:l,bits:a}=this;l===0&&(this.bits>=24?l=5:this.bits>=16?l=4:l=3),t.uniform1ui(s,l),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,i,0,t.RGBA,t.UNSIGNED_BYTE,r),t.drawElements(t.TRIANGLES,6,t.UNSIGNED_SHORT,0)}in_bounds(t,n){return t>=0&&t<this.width&&n>=0&&n<this.height}get width(){return this.gl.canvas.width}set width(t){this.gl.canvas.width=t}get height(){return this.gl.canvas.height}set height(t){this.gl.canvas.height=t}};var Ie=class{bits=8;down=new Uint8Array(256);keymap=Un;offset=0;constructor(){addEventListener("keydown",this.onkeydown.bind(this)),addEventListener("keyup",this.onkeyup.bind(this))}inputs={[67]:()=>this.down.slice(this.offset,this.offset+this.bits).reduceRight((t,n)=>(t<<1)+n,0)};outputs={[67]:t=>this.offset=t};key(t){return this.keymap[t]}onkeydown(t){let n=this.key(t.code);n!==void 0&&(this.down[n]=1)}onkeyup(t){let n=this.key(t.code);n!==void 0&&(this.down[n]=0)}};var Un={KeyA:4,KeyB:5,KeyC:6,KeyD:7,KeyE:8,KeyF:9,KeyG:10,KeyH:11,KeyI:12,KeyJ:13,KeyK:14,KeyL:15,KeyM:16,KeyN:17,KeyO:18,KeyP:19,KeyQ:20,KeyR:21,KeyS:22,KeyT:23,KeyU:24,KeyV:25,KeyW:26,KeyX:27,KeyY:28,KeyZ:29,Digit1:30,Digit2:31,Digit3:32,Digit4:33,Digit5:34,Digit6:35,Digit7:36,Digit8:37,Digit9:38,Digit0:39,Enter:40,Escape:41,Backspace:42,Tab:43,Space:44,Minus:45,Equal:46,BracketLeft:47,BracketRight:48,Backslash:49,Semicolon:51,Quote:52,Backquote:53,Comma:54,Period:55,Slash:56,CapsLock:57,F1:58,F2:59,F3:60,F4:61,F5:62,F6:63,F7:64,F8:65,F9:66,F10:67,F11:68,F12:69,PrintScreen:70,ScrollLock:71,Pause:72,Insert:73,Home:74,PageUp:75,Delete:76,End:77,PageDown:78,ArrowRight:79,ArrowLeft:80,ArrowDown:81,ArrowUp:82,NumLock:83,NumpadDivide:84,NumpadMultiply:85,NumpadSubtract:86,NumpadAdd:87,NumpadEnter:88,Numpad1:89,Numpad2:90,Numpad3:91,Numpad4:92,Numpad5:93,Numpad6:94,Numpad7:95,Numpad8:96,Numpad9:97,Numpad0:98,NumpadDecimal:99,IntlBackslash:100,Power:102,NumpadEqual:103,F13:104,F14:105,F15:106,F16:107,F17:108,F18:109,F19:110,F20:111,F21:112,F22:113,F23:114,F24:115,Help:117,ContextMenu:118,Props:118,Select:119,BrowserStop:120,MediaStop:120,Again:121,Undo:122,Copy:124,Paste:125,Find:126,AudioVolumeMute:127,VolumeMute:127,AudioVolumeUp:128,AudioVolumeDown:129,NumpadComma:133,IntlRo:135,IntlYen:132,Lang1:144,HangulMode:144,Lang2:145,Hanja:145,Lang3:146,Lang4:147,Cancel:155,NumpadParenLeft:182,NumpadParenRight:183,ControlLeft:224,ShiftLeft:225,AltLeft:226,OSLeft:227,MetaLeft:227,ControlRight:228,ShiftRight:229,AltRight:230,OSRight:231,MetaRight:231};var{A:$n,B:Mn,SELECT:Nn,START:Cn,LEFT:Fn,RIGHT:In,UP:Hn,DOWN:Wn}=Q;function Y(e,t=0){return{key:e,pad:t}}var He=class{keymap;buttons=0;constructor(t={}){this.keymap=t.keymap??{keyk:Y($n),keyj:Y(Mn),keyn:Y(Cn),keyv:Y(Nn),keya:Y(Fn),keyd:Y(In),keyw:Y(Hn),keys:Y(Wn)},addEventListener("keydown",this.onkeydown),addEventListener("keyup",this.onkeyup)}info(t){return t==0?1:0}axis;cleanup(){removeEventListener("keydown",this.onkeydown),removeEventListener("keyup",this.onkeyup)}key(t){return this.keymap[t.code.toLowerCase()]}onkeydown=t=>{let n=this.key(t);n!==void 0&&(this.buttons|=1<<n.key)};onkeyup=t=>{let n=this.key(t);n!==void 0&&(this.buttons&=~(1<<n.key))}};var We=class{constructor(t){this.canvas=t;addEventListener("mousemove",this.onmove),addEventListener("mousedown",this.ondown),addEventListener("mouseup",this.onup),addEventListener("contextmenu",this.oncontext)}translate(t,n){let{x:i,y:r,width:s,height:l}=this.canvas.getBoundingClientRect();return[(t-i)*this.canvas.width/s,(n-r)*this.canvas.height/l]}x=0;y=0;lastx=0;lasty=0;buttons=0;oncontext=t=>{t.ctrlKey||t.preventDefault()};onup=t=>{this.buttons=t.buttons,t.target===this.canvas&&t.preventDefault()};ondown=this.onup;onmove=t=>{if(document.pointerLockElement===null)[this.x,this.y]=this.translate(t.clientX,t.clientY);else{let{width:n,height:i}=this.canvas.getBoundingClientRect();this.x+=t.movementX*this.canvas.width/n,this.y+=t.movementY*this.canvas.height/i}};cleanup(){removeEventListener("mousemove",this.onmove),removeEventListener("mouseup",this.onup),removeEventListener("mousedown",this.ondown),removeEventListener("contextmenu",this.oncontext)}inputs={[68]:()=>this.x,[69]:()=>this.y,[70]:()=>{let t=0|this.x-this.lastx;return this.lastx+=t,t},[71]:()=>{let t=0|this.y-this.lasty;return this.lasty+=t,t},[73]:()=>this.buttons};outputs={}};var Ge=class{constructor(t=8){this.bits=t}inputs={[40]:()=>0|Math.random()*(4294967295>>>32-this.bits)}};var Gn=92.499,zn=.005,jt=.01,ut=class{constructor(t){this.ctx=t;this.oscillator=this.ctx.createOscillator(),this.gain=this.ctx.createGain(),this.gain.gain.value=0,this.gain.connect(this.ctx.destination),this.oscillator.connect(this.gain),this.oscillator.type="square",this.oscillator.start()}oscillator;gain;play(t,n,i){this.ctx.state==="suspended"&&this.ctx.resume(),this.oscillator.frequency.value=Gn*2**(t/12),this.gain.gain.setTargetAtTime(.1,this.ctx.currentTime,zn),this.gain.gain.setTargetAtTime(0,this.ctx.currentTime+n*.001,jt),setTimeout(()=>{i()},n*.1+jt)}},ze=class{ctx=new AudioContext;blocks=[];note=0;play(t,n){console.log(this.blocks.length,t,n);let i=this.blocks.pop();i||(i=new ut(this.ctx)),i.play(t,n,()=>this.blocks.push(i))}constructor(){}outputs={[41]:t=>{this.note=t},[43]:t=>{this.play(this.note,t)}}};var de=class{constructor(t,n,i){this.bits=t;this.little_endian=n;this.size=i}set_bytes(t){let{bits:n,size:i,little_endian:r}=this;switch(n){case 8:if(this.address_mask=255,this.data=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),i>this.data.length){let s=this.data;this.data=new Uint8Array(i),this.data.set(s)}break;case 16:this.address_mask=65535,this.data=$t(t,r,i);break;case 32:this.address_mask=4294967295,this.data=Mt(t,r,i);break;default:throw new Error(`${n} is not a supported word length for a Storage device`)}}get_bytes(){if(this.data instanceof Uint8Array)return new Uint8Array(this.data.buffer,this.data.byteOffset,this.data.byteLength);if(this.data instanceof Uint16Array)return Nt(this.data,this.little_endian);if(this.data instanceof Uint32Array)return Ct(this.data,this.little_endian);throw new Error(`${this.bits} is not a supported word length for a Storage device`)}inputs={[32]:this.address_in,[34]:this.page_in,[33]:this.bus_in};outputs={[32]:this.address_out,[34]:this.page_out,[33]:this.bus_out};data;address_mask;address=0;address_out(t){this.address=this.address&~this.address_mask|t}address_in(){return Math.min(2**this.bits,this.data.length-(this.address&~this.address_mask))}page_out(t){this.address=this.address&this.address_mask|t<<this.bits}page_in(){return Math.ceil(this.data.length/2**this.bits)}bus_out(t){if(this.address>this.data.length)throw Error(`Storage address out of bounds ${this.address} > ${this.data.length}`);this.data[this.address]=t}bus_in(){if(this.address>this.data.length)throw Error(`Storage address out of bounds ${this.address} > ${this.data.length}`);return this.data[this.address]}reset(){}};var me=(n=>(n[n.ONREAD=1]="ONREAD",n[n.ONWRITE=2]="ONWRITE",n))(me||{});function ct(e){return e.reduce((t,n)=>t|n,0)}var Ke=class{constructor(t){this.options=t}signed(t){return this.bits===32?0|t:(t&this.sign_bit)===0?t:t|4294967295<<this.bits}a=0;b=0;c=0;get sa(){return this.signed(this.a)}set sa(t){this.a=t}get sb(){return this.signed(this.b)}set sb(t){this.b=t}get sc(){return this.signed(this.c)}set sc(t){this.c=t}program;debug_info;_debug_message=void 0;get_debug_message(){let t=this._debug_message;return this._debug_message=void 0,t}heap_size=0;load_program(t,n){this._debug_message=void 0,this.program=t,this.debug_info=n,this.pc_counters=Array.from({length:t.opcodes.length},()=>0);let i=t.headers[0].value,r=t.data,s=t.headers[2].value,l=t.headers[4].value,a=t.headers[1].value+D,h=t.headers[3].value;if(this.heap_size=s,this.debug_reached=!1,h===1)throw new Error("emulator currently doesn't support running in ram");let m;if(i<=8)m=Uint8Array,this.bits=8;else if(i<=16)m=Uint16Array,this.bits=16;else if(i<=32)m=Uint32Array,this.bits=32;else throw new Error(`BITS = ${i} exceeds 32 bits`);if(a>this.max_size)throw new Error(`Too many registers ${a}, must be <= ${this.max_size}`);let f=s+l+r.length;if(f>this.max_size)throw new Error(`Too much memory heap:${s} + stack:${l} + dws:${r.length} = ${f}, must be <= ${this.max_size}`);let d=(f+a)*m.BYTES_PER_ELEMENT;if(this.buffer.byteLength<d){this.warn(`resizing Arraybuffer to ${d} bytes`);let p=this.options.max_memory?.();if(p&&d>p)throw new Error(`Unable to allocate memory for the emulator because	
${d} bytes exceeds the maximum of ${p}bytes`);try{this.buffer=new ArrayBuffer(d)}catch(g){throw new Error(`Unable to allocate enough memory for the emulator because:
	${g}`)}}this.registers=new m(this.buffer,0,a).fill(0),this.memory=new m(this.buffer,a*m.BYTES_PER_ELEMENT,f).fill(0);for(let p=0;p<r.length;p++)this.memory[p]=r[p];this.reset();for(let p of this.devices)p.bits=i}reset(){this.stack_ptr=this.memory.length,this.pc=0,this.ins=[],this.outs=[];for(let t of this.device_resets)t()}shrink_buffer(){this.buffer=new ArrayBuffer(1024*1024)}buffer=new ArrayBuffer(1024*1024);registers=new Uint8Array(32);memory=new Uint8Array(256);pc_counters=[];pc_full=0;get pc(){return this.pc_full}set pc(t){this.registers[0]=t,this.pc_full=t}get stack_ptr(){return this.registers[1]}set stack_ptr(t){this.registers[1]=t}bits=8;device_inputs={};device_outputs={};device_resets=[];devices=[];add_io_device(t){if(this.devices.push(t),t.inputs)for(let n in t.inputs){let i=t.inputs[n];this.device_inputs[n]=i.bind(t)}if(t.outputs)for(let n in t.outputs){let i=t.outputs[n];this.device_outputs[n]=i.bind(t)}t.reset&&this.device_resets.push(t.reset.bind(t))}get max_value(){return 4294967295>>>32-this.bits}get max_size(){return this.max_value+1}get max_signed(){return(1<<this.bits-1)-1}get sign_bit(){return 1<<this.bits-1}push(t){this.stack_ptr<=this.heap_size&&this.error(`Stack overflow: ${this.stack_ptr} <= ${this.heap_size}}`),this.memory[--this.stack_ptr]=t}pop(){return this.stack_ptr>=this.memory.length&&this.error(`Stack underflow: ${this.stack_ptr} >= ${this.memory.length}`),this.memory[this.stack_ptr++]}ins=[];outs=[];in(t){try{let n=this.device_inputs[t];if(n===void 0)return t===5?(this.a=this.device_inputs[this.supported]||this.device_outputs[this.supported]||this.supported===5?1:0,!1):(this.ins[t]===void 0&&this.warn(`unsupported input device port ${t} (${T[t]})`),this.ins[t]=1,!1);this.debug_info.port_breaks[t]&1&&this.debug(`Reading from Port ${t} (${T[t]})`);let i=n(this.finish_step_in.bind(this,t));return i===void 0?(this.debug_info.port_breaks[t]&1&&this.debug(`Read from port ${t} (${T[t]}) value=${i}`),this.pc--,!0):(this.a=i,this.debug_info.port_breaks[t]&1&&this.debug(`Read from port ${t} (${T[t]}) value=${i}`),!1)}catch(n){this.error(""+n)}}supported=0;out(t,n){try{let i=this.device_outputs[t];if(i===void 0){if(t===5){this.supported=n;return}this.outs[t]===void 0&&(this.warn(`unsupported output device port ${t} (${T[t]}) value=${n}`),this.outs[t]=n);return}if(this.debug_info.port_breaks[t]&2){let r="";try{let s=JSON.stringify(String.fromCodePoint(n));r=`'${s.substring(1,s.length-1)}'`}catch{}this.debug(`Written to port ${t} (${T[t]}) value=${n} ${r}`)}i(n)}catch(i){this.error(""+i)}}burst(t,n){let i=t,r=1024,s=performance.now()+n;for(;t>=r;t-=r){for(let l=0;l<r;l++){let a=this.step();if(a!==0)return[a,i-t+l+1]}if(performance.now()>s)return[0,i-t+r]}for(let l=0;l<t;l++){let a=this.step();if(a!==0)return[a,i-t+l+1]}return[0,i]}run(t){let i=performance.now()+t,r=0;do{for(let s=0;s<1024;s++){let l=this.step();if(l!==0)return[l,r+s+1]}r+=1024}while(performance.now()<i);return[0,r]}debug_reached=!1;step(){let t=this.pc++;if(this.debug_info.program_breaks[t]&&!this.debug_reached)return this.debug_reached=!0,this.debug("Reached @DEBUG Before:"),this.pc--,3;if(this.debug_reached=!1,t>=this.program.opcodes.length)return 1;this.pc_counters[t]++;let n=this.program.opcodes[t];if(n===36)return this.pc--,1;let[[i],r]=we[n];r===void 0&&this.error(`unkown opcode ${n}`);let s=this.program.operant_prims[t],l=this.program.operant_values[t],a=l.length;return a>=1&&i!==0&&(this.a=this.read(s[0],l[0])),a>=2&&(this.b=this.read(s[1],l[1])),a>=3&&(this.c=this.read(s[2],l[2])),r(this)?2:(a>=1&&i===0&&this.write(s[0],l[0],this.a),this._debug_message!==void 0?3:0)}m_set(t,n){t>=this.memory.length&&this.error(`Heap overflow on store: ${t} >= ${this.memory.length}`),this.debug_info.memory_breaks[t]&2&&this.debug(`Written memory[${t}] which was ${this.memory[t]} to ${n}`),this.memory[t]=n}m_get(t){return t>=this.memory.length&&this.error(`Heap overflow on load: #${t} >= ${this.memory.length}`),this.debug_info.memory_breaks[t]&1&&this.debug(`Read memory[${t}] = ${this.memory[t]}`),this.memory[t]}finish_step_in(t,n){let i=this.pc++,r=this.program.operant_prims[i][0],s=this.program.operant_values[i][0];this.write(r,s,n),this.options.on_continue?.()}write(t,n,i){switch(t){case 0:this.debug_info.register_breaks[n]&2&&this.debug(`Written r${n-D+1} which was ${this.registers[n]} to ${i}`),this.registers[n]=i;return;case 1:return;default:this.error(`Unknown operant target ${t}`)}}read(t,n){switch(t){case 1:return n;case 0:return this.debug_info.register_breaks[n]&1&&this.debug(`Read r${n-D+1} = ${this.registers[n]}`),this.registers[n];default:this.error(`Unknown operant source ${t}`)}}error(t){let{pc_line_nrs:n,lines:i,file_name:r}=this.debug_info,s=n[this.pc-1],l=this.decode_memory(this.stack_ptr,this.memory.length,!1),a=`${r??"eval"}:${s+1} - ERROR - ${t}
    ${i[s]}

${Lt(Se(this),1)}

stack trace:
${l}`;throw this.options.error&&this.options.error(a),Error(a)}get_line_nr(t=this.pc){return this.debug_info.pc_line_nrs[t-1]||-2}get_line(t=this.pc){let n=this.debug_info.lines[this.get_line_nr(t)];return n==null?"":`
	${n}`}format_message(t,n=this.pc){let{lines:i,file_name:r}=this.debug_info,s=this.get_line_nr(n);return`${r??"eval"}:${s+1} - ${t}
	${i[s]??""}`}warn(t){let n=this.format_message(`warning - ${t}`);this.options.warn?this.options.warn(n):console.warn(n)}debug(t){this._debug_message=(this._debug_message??"")+this.format_message(`debug - ${t}`)+`
`}decode_memory(t,n,i){let l=["hexaddr","hexval","value","*value","linenr","*opcode"].map(h=>tt(h,8)).join("|"),a=this.memory.slice(t,n);i&&(a=a.reverse());for(let[h,m]of a.entries()){let f=i?n-h:t+h,d=q(f,8," "),p=q(m,8," "),g=N(""+m,8),y=N(ae[this.program.opcodes[m]]??".",8),E=N(""+(this.debug_info.pc_line_nrs[m]??"."),8),k=N(""+(this.memory[m]??"."),8);l+=`
${d}|${p}|${g}|${k}|${E}|${y}`}return l}};function fe(e){let t=Z(e);return Number.isInteger(t)?t:void 0}function Z(e){return e=e.replace(/\_/g,""),e.startsWith("0b")?parseInt(e.slice(2),2):parseInt(e)}function Kn(e){e=e.replace(/\_/g,"");let t=parseFloat(e);if(!isNaN(t))return t}function Pn(e){e=e.replace(/\_/g,"");let t=parseFloat(e);if(!isNaN(t))return Ae(t)}var lt=class{errors=[];warnings=[];data=[];lines=[];headers={};constants={};labels={};instr_line_nrs=[];opcodes=[];operant_strings=[];operant_types=[];operant_values=[];register_breaks={};data_breaks={};heap_breaks={};program_breaks={};port_breaks={}};function Zt(e,t={}){let n=new lt;Object.assign(n.constants,t.constants??{}),n.lines=e.split(`
`).map(a=>a.replace(/,/g,"").replace(/\s+/g," ").replace(/\/\/.*/g,"").trim());for(let a=0;a<ke(te);a++)n.headers[a]={value:Ee[a].def},n.headers[a].operant=Ee[a].def_operant;let i,r,s=0,l=[];for(let a=0,h=0;a<n.lines.length;a++){l.push(h);let m=n.lines[a];if(m!==""&&(r=i,!(i=Vn(m,a,h,n,n.warnings))&&!Xn(m,a,n.headers,n.warnings))){if(Yn(m,a,h,n,n.errors)){r&&s===2&&n.warnings.push(_(a,"Label at data->instruction boundary")),s=1,h++;continue}if(m.startsWith("@")){let[f,...d]=m.split(" ");if(f.toLowerCase()==="@define"){if(d.length<2){n.warnings.push(_(a,`Expected 2 arguments for @define macro, got [${d}]`));continue}let[p,g]=d;n.constants[p.toUpperCase()]!==void 0&&n.warnings.push(_(a,`Redefinition of macro ${p}`)),n.constants[p.toUpperCase()]=g;continue}if(f.toLowerCase()==="@debug")continue;n.warnings.push(_(a,`Unknown marco ${f}`));continue}if(m.toUpperCase().startsWith("DW")){let[f,...d]=m.split(" ");d.length>1&&((d[0][0]!=="["||d.at(-1)?.at(-1)!=="]")&&n.warnings.push(_(a,"Omitting square brackets around a value list is not standard")),d[0]=d[0].replace("[","").trim(),d[0].length===0&&d.shift(),d[d.length-1]=d.at(-1)?.replaceAll("]","").trim()??"",d.at(-1)?.length===0&&d.pop()),r&&(s===1&&n.warnings.push(_(a,"Label at instruction->data boundary")),r.type=1,r.index=n.data.length),s=2;let p=0;for(;p<d.length;){let g=ht(()=>d[p++],a,-1,n.labels,n.constants,n.data,[],[]);g?.[0]!==6&&n.data.push(g?g[1]:-1)}continue}n.errors.push(_(a,`Unknown identifier ${m.split(" ")[0]}`))}}n.data.length=0;for(let a=0;a<n.opcodes.length;a++)qn(n.instr_line_nrs[a],a,n,n.errors,n.warnings);for(let a=0;a<n.lines.length;a++){let h=n.lines[a],[m,...f]=h.split(" ");if(m.toUpperCase()==="DW"){f.length>1&&(f[0]=f[0].replace("[","").trim(),f[0].length===0&&f.shift(),f[f.length-1]=f.at(-1)?.replaceAll("]","").trim()??"",f.at(-1)?.length===0&&f.pop());let d=0;for(;d<f.length;){let p=ht(()=>f[d++],a,-1,n.labels,n.constants,n.data,n.errors,n.warnings);p?.[0]!==6&&n.data.push(p?p[1]:-1)}}if(m.toUpperCase()==="@DEBUG"){let d=l[a],p=[],g=[];for(let E of f){let k=$(me,E);k!==void 0?p.push(k):g.push(E)}if(g.length==0){p.push(1),n.program_breaks[d]=ct(p);continue}p.length==0&&p.push(1,2);let y=ct(p);for(let E=0;E<g.length;E++){let k=jn(g[E],n.constants,a,n.errors);if(k!=null)switch(k[0]){case"r":case"R":case"$":{if(fe(k.slice(1))===void 0){n.errors.push(_(a,`${k} is not a valid register`));continue}n.register_breaks[Z(k.slice(1))+D-1]=y}break;case"m":case"M":case"#":{let[R,U]=k.slice(1).split("+"),M=fe(R);if(M===void 0){n.errors.push(_(a,`${R} is not a valid integer`));continue}if(U){let X=fe(U);if(X===void 0){n.errors.push(_(a,`${U} is not a valid integer`));continue}M+=X}n.heap_breaks[M]=y}break;case".":{let[R,U]=k.split("+"),M=n.labels[R];if(M===void 0){n.errors.push(_(a,`Undefined label ${R}`));continue}let X=M.index;if(U){let O=fe(U);if(O===void 0){n.errors.push(_(a,`${U} is not a valid integer`));continue}X+=O}M.type===1?n.data_breaks[X]=y:n.program_breaks[X]=y}break;case"%":{let R=Jt(k,a,n.errors);if(R===void 0)continue;n.port_breaks[R]=y}break;default:{if(k.toUpperCase()==="PC"){n.register_breaks[0]=y;continue}if(k.toUpperCase()==="SP"){n.register_breaks[1]=y;continue}n.warnings.push(_(a,`Unknown debug target/flag, expected register, heap location or label or one of [${V(me)}]`))}break}}}}return n}function Xn(e,t,n,i){let[r,s,l]=e.split(" ");if(r===void 0)return!1;let a=$(te,r.toUpperCase());if(a===void 0)return!1;let h=Ee[a];if(h.def_operant!==void 0&&l){s===void 0&&i.push(_(t,`Missing operant for header ${r}, must be ${V(ce)}`));let f=$(ce,s||"");f===void 0&&s!==void 0&&i.push(_(t,`Unknown operant ${s} for header ${r}, must be ${V(ce)}`));let d=m(l);f!==void 0&&d!==void 0&&(n[a]={line_nr:t,operant:f,value:d})}else{let f=m(s);f!==void 0&&(n[a]={line_nr:t,value:f})}return!0;function m(f){if(f===void 0){i.push(_(t,`Missing value for header ${r}`));return}if(h.in){let d=$(h.in,f.toUpperCase());if(d===void 0){i.push(_(t,`Value ${f} for header ${r} most be one of: ${V(h.in)}`));return}return d}else{let d=Z(f);if(!Number.isInteger(d)){i.push(_(t,`Value ${f} for header ${r} must be an integer`));return}return d}}}function Vn(e,t,n,i,r){if(!e.startsWith("."))return;let s=Qt(Qt(e," ").slice(0),"//");s==="."&&r.push(_(t,"Empty label")),i.labels[s]!==void 0&&r.push(_(t,`Duplicate label ${s}`));let l={type:0,index:n};return i.labels[s]=l,l}function Yn(e,t,n,i,r){let[s,...l]=e.replace(/' /g,"'\xA0").replace(/,/g,"").split(" "),a=$(ae,s.toUpperCase().replace("@","__"));if(a===void 0)return!1;let h=Rt[a];return l.length!=h&&r.push(_(t,`Expected ${h} operants but got [${l}] for opcode ${s}`)),i.opcodes[n]=a,i.operant_strings[n]=l,i.instr_line_nrs[n]=t,!0}function qn(e,t,n,i,r){let s=n.operant_types[t]=[],l=n.operant_values[t]=[],a=0,h=n.operant_strings[t];for(;a<h.length;){let[m,f]=ht(()=>h[a++],e,t,n.labels,n.constants,n.data,i,r)??[];m===6?i.push(_(e,"Strings are not allowed in instructions")):m!==void 0&&(s.push(m),l.push(f))}return 0}function jn(e,t,n,i){for(let r=0;r<10;r++){let s=t[e.toUpperCase()];if(s!==void 0)e=s;else break;if(r>=9){i.push(_(n,`Recursive macro (${e} -> ${s})`));return}}return e}function Jt(e,t,n){let i;if(nt(e,1)){if(i=fe(e.slice(1)),i===void 0){n.push(_(t,`Invalid port number ${e}`));return}}else if(i=$(T,e.slice(1).toUpperCase()),i===void 0){n.push(_(t,`Unkown port ${e}`));return}return i}function ht(e,t,n,i,r,s,l,a){let h=e();if(h!==void 0){for(let m=0;m<10;m++){let f=r[h.toUpperCase()];if(f!==void 0)h=f;else break;if(m>=9){l.push(_(t,`Recursive macro (${h} -> ${f})`));return}}switch(h.toUpperCase()){case"R0":case"$0":return[1,0];case"PC":return[0,0];case"SP":return[0,1]}switch(h[0]){case".":{let m=i[h];if(m===void 0){l.push(_(t,`Undefined label ${h}`));return}let{type:f,index:d}=m;if(f===0)return[3,d];if(f===1)return[4,d]}case"~":{let m=Z(h.slice(1));if(!Number.isInteger(m)){l.push(_(t,`Invalid relative address ${h}`));return}return[3,m+n]}case"R":case"r":case"$":{let m=Z(h.slice(1));if(!Number.isInteger(m)){l.push(_(t,`Invalid register ${h}`));return}return[0,m+D-1]}case"M":case"m":case"#":{let m=Z(h.slice(1));if(!Number.isInteger(m)){l.push(_(t,`Invalid memory address ${h}`));return}return[2,m]}case"%":{let m=Jt(h,t,l)??NaN;return[1,m]}case"'":{let m;h.length===1&&(h+=" "+e());try{m=JSON.parse(h.replace(/"/g,'\\"').replace(/'/g,'"'))}catch(f){l.push(_(t,`Invalid character ${h}
  ${f}`));return}return[1,m.codePointAt(0)??m.charCodeAt(0)]}case'"':{let m=1,f=s.length;for(;;){if(m=h.indexOf('"',1),m>0&&h[m-1]!=="\\"||h[m-2]==="\\"){let p="";try{p=JSON.parse(h)}catch(g){l.push(_(t,`Invalid string ${h}
  ${g}`));return}for(let g=0;g<p.length;g++)s.push(p.codePointAt(g)??0);return[6,f]}let d=e();if(d===void 0)return l.push(_(t,"missing end of string")),[6,f];h+=" "+d}}case"&":a.push(_(t,"Compiler constants with & are deprecated"));case"@":{let m=$(ue,h.slice(1).toUpperCase());if(m===void 0){l.push(_(t,`Unkown Compiler Constant ${h}`));return}return[5,m]}default:if(h.endsWith("f32")){let m=Pn(h);if(m===void 0){l.push(_(t,`Invalid immediate float ${h}`));return}return[1,m]}else if(h.endsWith("f16")){let m=Kn(h);if(m===void 0){l.push(_(t,`Invalid immediate float ${h}`));return}return[1,Le(m)]}else{let m=Z(h);if(!Number.isInteger(m)){l.push(_(t,`Invalid immediate int ${h}`));return}return[1,m]}}}}function Qt(e,t){let n=e.indexOf(t);return n<0?e:e.slice(0,n)}var G,A=!1,rn=!1,dt=!1,Pe=performance.now(),J=0,ie=0,z=document.getElementById("urcl-source"),W=document.getElementById("output"),Ot=document.getElementById("debug-output"),Qn=document.getElementById("memory-view"),Zn=document.getElementById("register-view"),pe=document.getElementById("stdin"),Xe=document.getElementById("stdout"),Jn=document.getElementById("null-terminate"),On=document.getElementById("share-button"),sn=document.getElementById("auto-run-input"),mt=document.getElementById("storage-input"),C=document.getElementById("storage-msg"),bt=document.getElementById("storage-little"),ei=document.getElementById("storage-update"),ti=document.getElementById("storage-download"),on=document.getElementById("clock-speed-input"),be=document.getElementById("clock-speed-output"),an=document.getElementById("update-mem-input"),_e=new URL(location.href,location.origin),en=_e.searchParams.get("srcurl"),tn=_e.searchParams.get("storage"),ni=parseInt(_e.searchParams.get("width")??""),ii=parseInt(_e.searchParams.get("height")??""),ft=$(j,_e.searchParams.get("color")??"");an.oninput=()=>qe();var un=4e7,nn=1.2*un/16;on.oninput=cn;function cn(){J=Math.min(un,Math.max(0,Number(on.value)||0)),be.value=""+J,Pe=performance.now()}cn();On.onclick=e=>{let t=`data:text/plain;base64,${btoa(z.value)}`,n=new URL(location.href);n.searchParams.set("srcurl",t),n.searchParams.set("width",""+I.width),n.searchParams.set("height",""+I.height),n.searchParams.set("color",j[re.color_mode]),navigator.clipboard.writeText(n.href)};var F,K,ri=0;function ln(e){F=new Uint8Array(e);let t=F.slice();v.add_io_device(K=new de(v.bits,bt.checked,t.length)),K.set_bytes(t),C.innerText=`loaded storage device with ${0|t.length/(v.bits/8)} words`}bt.oninput=mt.oninput=async e=>{C.classList.remove("error");let t=mt.files;if(t===null||t.length<1){C.classList.add("error"),C.innerText="No file specified";return}let n=t[0];try{ln(await n.arrayBuffer())}catch(i){C.classList.add("error"),C.innerText=""+i}};ei.onclick=e=>{if(K===void 0){C.innerText="No storage to update";return}F=K.get_bytes(),C.innerText="Updated storage"};ti.onclick=e=>{if(K===void 0&&F===void 0){C.innerText="No storage to download";return}K!==void 0&&(F=K.get_bytes());let t=URL.createObjectURL(new Blob([F])),n=document.createElement("a"),i=mt.value.split(/\\|\//).at(-1);n.download=i||"storage.bin",n.href=t,n.click(),setTimeout(()=>URL.revokeObjectURL(t),1e3)};var Ve;pe.addEventListener("keydown",e=>{!e.shiftKey&&e.key==="Enter"&&Ve&&(e.preventDefault(),Jn.checked?pe.value+="\0":pe.value+=`
`,Ve())});var si=new $e({read(e){Ve=e},get text(){return pe.value},set text(e){pe.value=e}},e=>{Xe.write(e)},()=>{Xe.clear(),Ve=void 0}),I=document.getElementsByTagName("canvas")[0],hn=I.getContext("webgl2");if(!hn)throw new Error("Unable to get webgl rendering context");I.width=ni||32;I.height=ii||32;var re=new Fe(hn,ft),_t=document.getElementById("color-mode");ft!==void 0&&(_t.value=j[ft]);_t.addEventListener("change",dn);function dn(){let e=$(j,_t.value);re.color_mode=e??re.color_mode,re.update_display()}var gt=document.getElementById("display-width"),xt=document.getElementById("display-height"),oi=document.getElementById("display-fullscreen");oi.onclick=()=>{I.requestPointerLock(),I.requestFullscreen()};gt.value=""+I.width;xt.value=""+I.height;gt.addEventListener("input",vt);xt.addEventListener("input",vt);vt();function vt(){let e=parseInt(gt.value)||16,t=parseInt(xt.value)||16;re.resize(e,t)}var v=new Ke({on_continue:Ye,warn:e=>W.innerText+=`${e}
`});v.add_io_device(new ze);v.add_io_device(si);v.add_io_device(re);v.add_io_device(new Ue);var mn=new Ne;mn.add_pad(new He);v.add_io_device(mn);v.add_io_device(new Ge);v.add_io_device(new Ie);v.add_io_device(new We(I));z.oninput=fn;sn.onchange=fn;function fn(){if(rn){localStorage.setItem("history-size",""+8);let t=(Math.max(0,0|(Number(localStorage.getItem("history-offset"))||0))+1)%8;localStorage.setItem("history-offset",""+t),localStorage.setItem(`history-${t}`,z.value)}sn.checked&&yt()}var ai=document.getElementById("compile-and-run-button"),B=document.getElementById("pause-button"),ui=document.getElementById("compile-and-reset-button"),P=document.getElementById("step-button");ai.addEventListener("click",yt);ui.addEventListener("click",bn);B.addEventListener("click",pn);P.addEventListener("click",ci);function ci(){pt(v.step(),1),be.value=`stepping, executed ${H(ie)} instructions`,Xe.flush()}function pn(){A?(G&&cancelAnimationFrame(G),G=void 0,B.textContent="Start",A=!1,P.disabled=A||dt):(G=requestAnimationFrame(Ye),B.textContent="Pause",A=!0,P.disabled=A)}function yt(){!bn()||(B.textContent="Pause",B.disabled=!1,A||(A=!0,P.disabled=A,Ye()))}function bn(){ie=0,W.innerText="";try{let e=z.value,t=Zt(e,{constants:Object.fromEntries([...V(Q).map(r=>[`@${r}`,`${1<<Q[r]}`]),...V(Ce).map(r=>[`@${r}`,`${Ce[r]}`])])});if(t.errors.length>0)return W.innerText=t.errors.map(r=>Re(r,t.lines)+`
`).join(""),W.innerText+=t.warnings.map(r=>Re(r,t.lines)+`
`).join(""),!1;W.innerText+=t.warnings.map(r=>Re(r,t.lines)+`
`).join("");let[n,i]=Pt(t);if(v.load_program(n,i),F){let r=F.slice();v.add_io_device(K=new de(v.bits,bt.checked,r.length)),K.set_bytes(r),C.innerText=`loaded storage device with ${0|r.length/(v.bits/8)} words, ${ri++%2===0?"flip":"flop"}`}return W.innerText+=`
compilation done
bits: ${v.bits}
register-count: ${v.registers.length}
memory-size: ${v.memory.length}
`,G&&cancelAnimationFrame(G),G=void 0,B.textContent="Start",B.disabled=!1,P.disabled=!1,A=!1,qe(),!0}catch(e){throw W.innerText+=e.message,e}}function Ye(){if(A)try{if(J>0){let e=performance.now(),t=e-Pe,n=Math.min(nn,0|t*J/1e3),[i,r]=v.burst(n,16);pt(i,r),n===nn||i===0&&r!==n?(Pe=e,be.value=`${H(J)}Hz slowdown to ${H(r*1e3/16)}Hz, executed ${H(ie)} instructions`):(Pe+=n*1e3/J,be.value=`${H(J)}Hz, executed ${H(ie)} instructions`)}else{let e=performance.now(),[t,n]=v.run(16),i=performance.now(),r=Math.max(.1,i-e);pt(t,n),be.value=`${H(n*1e3/r)}Hz, executed ${H(ie)} instructions`}}catch(e){throw W.innerText+=e.message+`
Program Halted`,qe(),e}else P.disabled=!1,B.disabled=!1}function pt(e,t){switch(ie+=t,G=void 0,dt=!1,Ot.innerText="",e){case 0:A&&(G=requestAnimationFrame(Ye),A=!0,P.disabled=A,B.disabled=!1);break;case 2:P.disabled=!0,B.disabled=!1,dt=!0;break;case 1:W.innerText+="Program halted",P.disabled=!0,B.disabled=!0,B.textContent="Start",A=!1;break;case 3:{A&&pn();let n=v.get_debug_message();if(n!==void 0)Ot.innerText=n;else throw new Error("Debug not handled")}break;default:console.warn("unkown step result")}qe()}function qe(){let e=v.bits;an.checked&&(Qn.innerText=At(v.memory,0,v.memory.length,e)),Zn.innerText=Se(v);let t=v.debug_info.pc_line_nrs,n=t[Math.min(v.pc,t.length-1)];z.set_pc_line(n),z.set_line_profile(v.pc_counters.map((i,r)=>[t[r],i])),Xe.flush()}dn();rn=!0;if(en)fetch(en).then(e=>e.text()).then(e=>{z.value||(z.value=e,yt())});else e:{let e=Number(localStorage.getItem("history-offset"));if(!Number.isInteger(e))break e;z.value=localStorage.getItem(`history-${e}`)??""}tn&&fetch(tn).then(e=>e.arrayBuffer()).then(e=>{console.log(F,e),F==null&&ln(e)});
//# sourceMappingURL=index.js.map
