BITS 16
MINREG 30
MINSTACK 2
MINHEAP 10000
@define x r1
@define y r2
@define i r3
@define old_frame r4
@define new_frame r5
@define top0_3_6 r6
@define top1_4_7 r7
@define top2_5_8 r8
@define t1 r9
@define t2 r10
@define line0 r11
@define line1 r12
@define line2 r13
@define line3 r14
@define line4 r15
@define line5 r16
@define result1 r20
@define @line_size_x0 0
@define @line_size_x1 5 // = roof(width / 13)
@define @line_size_x2 10
@define @line_size_x3 15
@define @line_size_x4 20
// frame_size = height * line_size + line_size (padding)
PSH .frame1
PSH .frame2
.game_loop
    // swapping frame buffers each turn
    POP new_frame
    POP old_frame
    PSH new_frame
    PSH old_frame
    SUB old_frame old_frame @line_size_x1
    IMM y 0
    .y_loop
        IMM x 0
        IMM result1 0
        LLOD line0 old_frame @line_size_x0
        LLOD line1 old_frame @line_size_x1
        LLOD line2 old_frame @line_size_x2
        INC old_frame old_frame
        IMM i 1
        .x_loop
            LSH line0 line0
            LSH line1 line1
            LSH line2 line2
            BNE .x14_skip i 14
                LLOD t1 old_frame @line_size_x0
                ADD line0 line0 t1
                LLOD t1 old_frame @line_size_x1
                ADD line1 line1 t1
                LLOD t1 old_frame @line_size_x2
                ADD line2 line2 t1
                INC old_frame old_frame
            .x14_skip
            LSH result1 result1

            // algorithm
            AND top0_3_6 line0 0xE000
            AND top1_4_7 line1 0xE000
            AND top2_5_8 line2 0xE000
            BSR t1 top0_3_6 7
            BSR t2 top1_4_7 10
            ADD t1 t1 t2
            BSR t2 top2_5_8 13
            ADD t1 t1 t2
            LLOD t1 .gol_lut t1
            ADD result1 result1 t1

            // display
            OUT%X x
            OUT%Y y
            OUT%COLOR t1

            BNE .x14_skip2 i 14
                LSTR new_frame @line_size_x0 result1
                INC new_frame new_frame
                IMM result1 0
                IMM i 0
            .x14_skip2

            INC i i
            INC x x
            BRL .x_loop x 64
        BSL result1 result1 6 // 14 * line_size - width
        LSTR new_frame @line_size_x0 result1
        INC new_frame new_frame
        INC y y
        BRL .y_loop y 64
@debug
    JMP .game_loop

DW
.gol_lut
DW [ 0 0 0 0 0 0 0 1 0 0 0 1 0 1 1 0 0 0 0 1 0 1 1 1 0 1 1 1 1 1 1 0 ]
DW [ 0 0 0 1 0 1 1 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 0 1 1 1 0 1 0 0 0 ]
DW [ 0 0 0 1 0 1 1 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 0 1 1 1 0 1 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 0 0 0 1 0 1 1 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 0 1 1 1 0 1 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]
DW [ 0 0 0 1 0 1 1 0 0 1 1 0 1 0 0 0 0 1 1 1 1 1 1 0 1 1 1 0 1 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]
DW [ 0 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 1 1 1 0 1 0 0 0 1 0 0 0 0 0 0 0 ]
DW [ 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]
DW [ 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]
DW [ 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ]
DW [ 0 0 0 0 0 ] // padding
.frame1
DW [ 0b11000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000011_000000 ]
DW [ 0b11000000000000 0b00000000000010 0b00000000000000 0b00000000000000 0b00000011_000000 ]
DW [ 0b00000000000000 0b00000000001010 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b01000000010100 0b00000000011000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b11000000100100 0b00000000011000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00011000000001 0b10000110010100 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00011000000011 0b10000110001010 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000001 0b10000110000010 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b11000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b01000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b01110000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00100000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000011_000000 ]
DW [ 0b00000000000000 0b00000000000000 0b00000000000000 0b00000000000000 0b00000011_000000 ]
DW [ 0 0 0 0 0 ] // padding
.frame2
DW